/*
 *  jquery-eclipsefdn-api - v0.0.4
 *  Fetch and display data from various Eclipse Foundation APIs.
 *  https://github.com/EclipseFdn/jquery-eclipsefdn-api
 *
 *  Made by Christopher Guindon
 *  Under MIT License
 *
 *  Thanks to https://github.com/jquery-boilerplate/jquery-boilerplate, MIT License Â© Zeno Rocha
 */
!function(a,b,c,d){"use strict";function e(b,c){this.element=b,this.settings=a.extend({},g,c),this._defaults=g,this._name=f,this.init()}var f="eclipseFdnApi",g={apiUrl:"https://api.eclipse.org",gerritUrl:"https://git.eclipse.org/r",eventUrl:"https://events.eclipse.org/data/EclipseEvents.json",forumsUrl:"https://www.eclipse.org/forums",marketplaceUrl:"https://marketplace.eclipse.org",username:"cguindon",currentUser:"",statPlaceholder:null,errorMsg:'<i class="fa red fa-exclamation-triangle" aria-hidden="true"></i> An unexpected error has occurred.',gerritUserNotFoundMsg:'<h2 class="h3">Outgoing Reviews</h2>There are no outgoing reviews for this user.<h2 class="h3">Incoming Reviews</h2>There are no incoming reviews for this account.',type:""};a.extend(e.prototype,{init:function(){var b=["mpFavorites","gerritReviews","recentEvents","forumsMsg"];"string"===a.type(this.settings.type)&&a.inArray(this.settings.type,b)!==-1&&this[this.settings.type]()},forumsMsg:function(){var b=this,c=this.settings.username,e=this.settings.apiUrl;if(!c&&!api_url)return!1;var f=e+"/account/profile/"+c+"/forum";a.ajax(f,{context:this.element,success:function(c){var e=a(this),f=a("<a></a>");e.append(a("<h2></h2>").addClass("h3").text("Eclipse Forums")),e.append(a("<p></p>").append("The Eclipse forums are your way of communicating with the community of people developing and using Eclipse-based tools hosted at Eclipse.org. Please stick to technical issues - and remember, no confidential information - these are public forums!"));var g=f.clone().attr({href:b.settings.forumsUrl,class:"btn btn-primary btn-sm",style:"display:block"}).html('<i class="fa fa-angle-double-right" aria-hidden="true"></i> More');if(b.settings.statPlaceholder instanceof jQuery){var h=0;c.posted_msg_count!==d&&(h=c.posted_msg_count),b.settings.statPlaceholder.children("strong").text(h+" posts")}if(0===c.length)return e.append('<div class="alert alert-warning" role="alert">This user does not have any activities on Eclipse Forums.</div>'),e.append(g),!1;var i=a("<table></table>").attr({width:"100%",class:"table"}),j=a("<tr></tr>"),k=a("<th></th>"),l=a("<td></td>");j.append(k.clone().text("Topic").attr("width","50%")),j.append(k.clone().text("Replies").attr({width:"10%",class:"text-center"})),j.append(k.clone().text("Views").attr({width:"10%",class:"text-center"})),j.append(k.clone().text("Last message").attr({width:"30%",class:"text-center"})),i.append(j),a.each(c.posts,function(d,e){var g={forum_id:e.thread_forum_id,forum_name:e.forum_name,forum_cat_id:e.forum_name,forum_cat_name:e.cat_name,root_subject:e.root_msg_subject,current_user_last_post_timestamp:e.msg_group_post_stamp,current_user_last_post_subject:e.last_user_msg_subject,thread_id:e.msg_thread_id,thread_reply_count:e.thread_replies,thread_views_count:e.thread_views,thread_last_post_date:e.thread_last_post_date,last_message_timestamp:e.last_msg_post_stamp,last_message_poster_id:e.last_msg_poster_id,last_message_poster_alias:e.last_poster_alias,last_message_last_view:e.read_last_view,current_user_id:c.id};j=a("<tr></tr>");var h=f.clone().attr({href:b.settings.forumsUrl+"/index.php/f/"+g.forum_id+"/"}).text(g.forum_name),k=f.clone().attr({href:b.settings.forumsUrl+"/index.php/i/"+g.forum_cat_id+"/"}).text(g.forum_cat_name),m=a("<small></small>").append("<br/>").append(k).append(" &gt; ").append(h).append(" &gt; ").append(g.root_subject).append("<br>Posted on "+b.dateFormat(new Date(parseInt(1e3*g.current_user_last_post_timestamp))));j.append(l.clone().html(f.clone().attr({href:b.settings.forumsUrl+"/index.php/t/"+g.thread_id+"/"}).text(g.current_user_last_post_subject)).append(m)),j.append(l.clone().text(g.thread_reply_count).attr("class","text-center")),j.append(l.clone().text(g.thread_views_count).attr("class","text-center"));var n=a("<small></small>").append(b.dateFormat(new Date(parseInt(1e3*g.last_message_timestamp)))).append("<br/> By: ").append(f.clone().attr({href:b.settings.forumsUrl+"/index.php/u/"+g.last_message_poster_id+"/"}).text(g.last_message_poster_alias));j.append(l.clone().html(n).attr("class","text-center")),b.settings.currentUser===b.settings.username&&g.last_message_last_view<g.thread_last_post_date&&g.last_message_poster_id!==g.current_user_id&&j.addClass("warning"),i.append(j)}),e.append(i),e.append(g)},error:function(){a(this).html(b.settings.errorMsg)}})},mpFavorites:function(){var b=this,c=this.settings.username,d=this.settings.apiUrl;if(!c&&!api_url)return!1;var e=a(this.element),f=a("<a></a>").attr({href:b.settings.marketplaceUrl,class:"btn btn-primary btn-sm",style:"display:block"}).html('<i class="fa fa-angle-double-right" aria-hidden="true"></i> More'),g=d+"/marketplace/favorites?name="+c;a.ajax(g,{context:this.element,success:function(c){b.settings.statPlaceholder instanceof jQuery&&b.settings.statPlaceholder.children("strong").text(c.total_result_count+" favorites");var d=[];if(a.each(c.mpc_favorites,function(a,b){d.push(b.content_id)}),e.append(a("<h2></h2>").addClass("h3").text("Eclipse Marketplace Favorites")),e.append(a("<p></p>").append("Eclipse Marketplace is the source for Eclipse-based solutions, products and add-on features. Thousands of developers visit Marketplace on a monthly basis to find new and innovative solutions. Solution providers are encouraged to list their products on Marketplace to gain exposure to the Eclipse developer community.")),0===d.length)return e.append('<div class="alert alert-warning" role="alert">There are no marketplace favorites for this user.</div>'),e.append(f),!1;var g=d.join(","),h=b.settings.marketplaceUrl+"/node/"+g+"/api/p";a.ajax(h,{context:b.element,success:function(c){e.append('<div class="alert alert-info" role="alert"><label>Copy this URL and paste it into MPC to install this list of favorites in your workspace: </label><input class="text-full form-control form-text" type="text" readonly value="https://marketplace.eclipse.org/user/'+b.settings.username+'/favorites" width="100"></div>');var d=a("node",c);d.each(function(c,d){var g=a(d),h=g.find("shortdescription").text(),i=d.getAttribute("name"),j=g.find("changed").text(),k=g.find("owner").text(),l="Last Updated on "+b.dateFormat(new Date(parseInt(1e3*j)))+" by "+k,m=d.getAttribute("id"),n=a("#mp-listing-template").clone().removeClass("hidden").removeAttr("id"),o=a("<a></a>"),p=a("category",d),q=b.settings.marketplaceUrl+"/node/"+m,r=g.find("image").text(),s=o.clone().attr({href:q});p.each(function(a,b){var c=o.clone().attr({href:b.getAttribute("url")}).text(b.getAttribute("name"));p.length!==a+1&&c.append(", "),n.find(".content-categories").append(c)}),n.find(".listing-image").attr({href:q,style:"background:url('"+r+"') no-repeat center;"}),n.find(".drag").attr({href:b.settings.marketplaceUrl+"/marketplace-client-intro?mpc_install="+m}),n.find(".listing-title").html(s.clone().text(i)),n.find(".content-teaser").html(h),n.find(".content-last-updated").html(l),e.append(n),e.append(f)})},error:function(){a(this).html(b.settings.errorMsg)}})},error:function(){a(this).html(b.settings.errorMsg)}})},gerritReviews:function(){function b(a){var b=100,d=0;c(a,b,d)}function c(b,d,e){d="undefined"!=typeof d?d:100,e="undefined"!=typeof e?e:0,b+="&start="+e+"&n="+d,a.ajax(b,{dataType:"gerrit_XSSI",converters:{"text gerrit_XSSI":function(a){var b=a.substring(a.indexOf("\n")+1);return jQuery.parseJSON(b)}},success:function(a){if(0!==a.length){j+=a.length;var g=a[a.length-1];"_more_changes"in g&&g._more_changes===!0&&c(b,d,e+d)}f.settings.statPlaceholder instanceof jQuery&&f.settings.statPlaceholder.children("strong").text(j+" reviews")},error:function(b){400===b.status?a(this).html(f.settings.gerritUserNotFoundMsg):f.settings.statPlaceholder instanceof jQuery&&$self.settings.statPlaceholder.children("strong").text(j+" reviews")}})}function d(b,c){var d=a("<a></a>").attr({href:f.settings.gerritUrl,class:"btn btn-primary btn-sm",style:"display:block"}).html('<i class="fa fa-angle-double-right" aria-hidden="true"></i> More');b!==i?e(i,"gerrit-incoming","Incoming Reviews",c):c.append(d)}function e(b,c,e,g){a.ajax(b+"&n=10&start=0",{dataType:"gerrit_XSSI",context:g,converters:{"text gerrit_XSSI":function(a){var b=a.substring(a.indexOf("\n")+1);return jQuery.parseJSON(b)}},success:function(c){var g=a(this),h=a("<h4></h4>").addClass("h4").text(e);if(g.append(h),0===c.length)return g.append('<div class="alert alert-warning" role="alert">There are no '+e.toLowerCase()+" for this user.</div>"),d(b,g),!1;var i=a("<table></table>").attr({width:"100%",class:"table"}),j=a("<tr></tr>"),k=a("<th></th>"),l=a("<td></td>");j.append(k.clone().text("Subject").attr("width","70%")),j.append(k.clone().text("Status").attr({width:"18%",class:"text-center"})),j.append(k.clone().text("Updated").attr({width:"12%",class:"text-center"})),i.append(j);var m=a("<a></a>");a.each(c,function(b,c){j=a("<tr></tr>");var d="";c.mergeable===!1&&(d="Merge Conflict",j.addClass("warning"));var e=c.updated.substring(0,c.updated.indexOf(" "));j.append(l.clone().html(m.clone().attr({href:f.settings.gerritUrl+"/"+c._number}).text(c.subject)).append("<br/>"+c.project)),j.append(l.clone().text(d).attr("class","text-center")),j.append(l.clone().text(e).attr("class","text-center")),i.append(j)}),g.append(i),d(b,g)},error:function(c){400===c.status?(a(this).html(f.settings.gerritUserNotFoundMsg),d(b,container)):a(this).html(f.settings.errorMsg)}})}var f=this,g=this.settings.gerritUrl+"/changes/?q=owner:"+this.settings.username+"+status:open",h=this.settings.gerritUrl+"/changes/?q=reviewer:"+this.settings.username+"+status:merged",i=this.settings.gerritUrl+"/changes/?q=reviewer:"+this.settings.username+"+status:open+-owner:"+this.settings.username;e(g,"gerrit-outgoing","Outgoing Reviews",this.element),b(h);var j=0;a(this.element).append(a("<h2>Eclipse Gerrit</h2>").addClass("h3")),a(this.element).append("<p>Gerrit is a web based code review system, facilitating online code reviews for projects using the Git version control system.</p>")},recentEvents:function(){function b(a,b){return a.dateTime-b.dateTime}var c=this;a.ajax(this.settings.eventUrl,{context:this.element,success:function(d){var e=new Date,f=[];for(var g in d.events)d.events[g].dateTime=new Date(d.events[g].date),d.events[g].dateTime>=e&&f.push(d.events[g]);f.sort(b);var h=a("<ul></ul>").attr({class:"nav",style:"margin:0"});for(var i in f.slice(0,5)){var j=f[i].dateTime,k=c.dateFormat(j),l=a("<a>").attr({href:f[i].infoLink}).html(f[i].title+"<br/><small>"+k+"</small>"),m=a("<li></li>").append(l);h.append(m)}a(this).children(".loading").remove(),a(this).append(h);var n=a("<a>").attr({href:"http://events.eclipse.org",class:"btn btn-simple btn-sm"}).text("more");a(this).append(n)},error:function(){a(this).html(c.settings.errorMsg)}})},dateFormat:function(a){var b=["January","February","March","April","May","June","July","August","September","October","November","December"],c=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],d=a.getFullYear(),e=b[a.getMonth()],f=c[a.getDay()],g=a.getDate(),h=("0"+a.getHours()).slice(-2),i=("0"+a.getMinutes()).slice(-2),j=f+", "+e+" "+g+", "+d+" - "+h+":"+i;return j}}),a.fn[f]=function(b){return this.each(function(){a.data(this,"plugin_"+f)||a.data(this,"plugin_"+f,new e(this,b))})}}(jQuery,window,document);