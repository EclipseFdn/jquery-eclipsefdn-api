/*
 *  jquery-eclipsefdn-api - v0.0.2
 *  Fetch and display data from various Eclipse Foundation APIs.
 *  https://github.com/EclipseFdn/jquery-eclipsefdn-api
 *
 *  Made by Christopher Guindon
 *  Under MIT License
 *
 *  Thanks to https://github.com/jquery-boilerplate/jquery-boilerplate, MIT License Â© Zeno Rocha
 */
!function(a,b,c,d){"use strict";function e(b,c){this.element=b,this.settings=a.extend({},g,c),this._defaults=g,this._name=f,this.init()}var f="eclipseFdnApi",g={apiUrl:"https://api.eclipse.org",gerritUrl:"https://git.eclipse.org/r",eventUrl:"https://events.eclipse.org/data/EclipseEvents.json",marketplaceUrl:"https://marketplace.eclipse.org",username:"cguindon",mpFavoritesNodes:[],errorMsg:'<i class="fa red fa-exclamation-triangle" aria-hidden="true"></i> An unexpected error has occurred.',gerritUserNotFoundMsg:'<h2 class="h3">Outgoing Reviews</h2>There are no outgoing reviews for this user.<h2 class="h3">Incoming Reviews</h2>There are no incoming reviews for this account.',type:""};a.extend(e.prototype,{init:function(){var b=["mpFavorites","mpFavoritesCount","gerritReviews","recentEvents"];"string"===a.type(this.settings.type)&&a.inArray(this.settings.type,b)!==-1&&this[this.settings.type]()},dateFormat:function(a){var b=["January","February","March","April","May","June","July","August","September","October","November","December"],c=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],d=a.getFullYear(),e=b[a.getMonth()],f=c[a.getDay()],g=a.getDate(),h=("0"+a.getHours()).slice(-2),i=("0"+a.getMinutes()).slice(-2),j=f+", "+e+" "+g+", "+d+" - "+h+":"+i;return j},mpFavorites:function(){var b=this,c=this.settings.mpFavoritesNodes.join(","),d=this.settings.marketplaceUrl+"/node/"+c+"/api/p";a.ajax(d,{context:this.element,success:function(c){var d=a(this),e=a("<h2></h2>").addClass("h3").text("Marketplace Favorites");if(d.append(e),0===c.length)return d.append("There are no marketplace favorites for this user."),!1;var f=a("node",c);f.each(function(c,e){var f=a(e),g=f.find("shortdescription").text(),h=e.getAttribute("name"),i=f.find("changed").text(),j=f.find("owner").text(),k="Last Updated on "+b.dateFormat(new Date(parseInt(1e3*i)))+" by "+j,l=e.getAttribute("id"),m=a("#mp-listing-template").clone().removeClass("hidden").removeAttr("id"),n=a("<a></a>"),o=a("category",e),p=b.settings.marketplaceUrl+"/node/"+l,q=f.find("image").text(),r=n.clone().attr({href:p});o.each(function(a,b){var c=n.clone().attr({href:b.getAttribute("url")}).text(b.getAttribute("name"));o.length!==a+1&&c.append(", "),m.find(".content-categories").append(c)}),m.find(".listing-image").attr({href:p,style:"background:url('"+q+"') no-repeat center;"}),m.find(".drag").attr({href:b.settings.marketplaceUrl+"/marketplace-client-intro?mpc_install="+l}),m.find(".listing-title").html(r.clone().text(h)),m.find(".content-teaser").html(g),m.find(".content-last-updated").html(k),d.append(m)})},error:function(){a(this).html(b.settings.errorMsg)}})},mpFavoritesCount:function(){var b=this,c=this.settings.username,d=this.settings.apiUrl;if(!c&&!api_url)return FALSE;var e=d+"/marketplace/favorites?name="+c;a.ajax(e,{context:this.element,success:function(c){a(this).text(c.total_result_count+" fav"),b.settings.mpFavoritesNodes.length=0,a.each(c.mpc_favorites,function(a,c){b.settings.mpFavoritesNodes.push(c.content_id)})},error:function(){a(this).html(b.settings.errorMsg)}})},gerritReviews:function(){function b(b,d,e,f){a.ajax(b,{dataType:"gerrit_XSSI",context:f,converters:{"text gerrit_XSSI":function(a){var b=a.substring(a.indexOf("\n")+1);return jQuery.parseJSON(b)}},success:function(b){var d=a(this),f=a("<h2></h2>").addClass("h3").text(e);if(d.append(f),0===b.length)return d.append("There are no "+e.toLowerCase()+" for this user."),FALSE;var g=a("<table></table>").attr({width:"100%",class:"table"}),h=a("<tr></tr>"),i=a("<th></th>"),j=a("<td></td>");h.append(i.clone().text("Subject").attr("width","70%")),h.append(i.clone().text("Status").attr({width:"18%",class:"text-center"})),h.append(i.clone().text("Updated").attr({width:"12%",class:"text-center"})),g.append(h);var k=a("<a></a>");a.each(b,function(b,d){h=a("<tr></tr>");var e="";d.mergeable===!1&&(e="Merge Conflict",h.addClass("warning"));var f=d.updated.substring(0,d.updated.indexOf(" "));h.append(j.clone().html(k.clone().attr({href:c.settings.gerritUrl+"/"+d._number}).text(d.subject)).append("<br/>"+d.project)),h.append(j.clone().text(e).attr("class","text-center")),h.append(j.clone().text(f).attr("class","text-center")),g.append(h)}),d.append(g)},error:function(b){400===b.status?a(this).html(c.settings.gerritUserNotFoundMsg):a(this).html(c.settings.errorMsg)}})}var c=this,d=this.settings.gerritUrl+"/changes/?q=owner:"+this.settings.username+"+status:open",e=this.settings.gerritUrl+"/changes/?q=reviewer:"+this.settings.username+"+status:open+-owner:"+this.settings.username;b(d,"gerrit-outgoing","Outgoing Reviews",this.element),b(e,"gerrit-incoming","Incoming Reviews",this.element)},recentEvents:function(){function b(a,b){return a.dateTime-b.dateTime}var c=this;a.ajax(this.settings.eventUrl,{context:this.element,success:function(d){var e=new Date,f=[];for(var g in d.events)d.events[g].dateTime=new Date(d.events[g].date),d.events[g].dateTime>=e&&f.push(d.events[g]);f.sort(b);var h=a("<ul></ul>").attr({class:"nav",style:"margin:0"});for(var i in f.slice(0,5)){var j=f[i].dateTime,k=c.dateFormat(j),l=a("<a>").attr({href:f[i].infoLink}).html(f[i].title+"<br/><small>"+k+"</small>"),m=a("<li></li>").append(l);h.append(m)}a(this).children(".loading").remove(),a(this).append(h);var n=a("<a>").attr({href:"http://events.eclipse.org",class:"btn btn-simple btn-sm"}).text("more");a(this).append(n)},error:function(){a(this).html(c.settings.errorMsg)}})}}),a.fn[f]=function(b){return this.each(function(){a.data(this,"plugin_"+f)||a.data(this,"plugin_"+f,new e(this,b))})}}(jQuery,window,document);