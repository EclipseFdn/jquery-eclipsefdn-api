/*
 *  jquery-eclipsefdn-api - v0.0.22
 *  Fetch and display data from various Eclipse Foundation APIs.
 *  https://github.com/EclipseFdn/jquery-eclipsefdn-api
 *
 *  Made by Christopher Guindon
 *  Under MIT License
 *
 *  Thanks to https://github.com/jquery-boilerplate/jquery-boilerplate, MIT License Â© Zeno Rocha
 */
!function(a,b,c,d){"use strict";function e(b,c){this.element=b,this.settings=a.extend({},g,c),this._defaults=g,this._name=f,this.init()}var f="eclipseFdnIgc",g={clientName:"unknown",authUrl:"https://accounts.eclipse.org",apiUrl:"https://api.eclipse.org",redirectUri:[location.protocol,"//",location.host,"/site_login/implicit_grant/authorized"].join(""),baseStorageName:"eclipseIGC",redirectIfValid:!0,validateUser:!0,encodeStorage:!0,username:"",completeOnAuthorization:!0};a.extend(e.prototype,{authorizeClient:function(){if(0===this.settings.authUrl.length){var a={error:400,error_description:"authorization end-point not defined",error_from:"authorizeClient"};this.storeItem("error_msg",a)}this.storeItem("return_location",{prevLoc:b.location.href});var c=this.getNewState(),d=this.settings.authUrl+"/oauth2/authorize?response_type=token&client_id="+this.request.cid+"&redirect_uri="+encodeURIComponent(this.settings.redirectUri)+"&scope="+encodeURIComponent(this.request.scope)+"&state="+c;self.location=d},getDelayedAction:function(){return this.getStoredItem("request",!0)},getNewState:function(){var a=function(){return Math.random().toString(36).substr(2)},b=a()+a();return this.storeItem("state",{state:b}),b},getStoredItem:function(a,b){function d(a){try{return e.settings.encodeStorage?JSON.parse(atob(a)):JSON.parse(a)}catch(b){if(b instanceof DOMException)return JSON.parse(a);if(b instanceof SyntaxError)return JSON.parse(atob(a))}}var e=this,f=this.getStoreName(a);void 0===b&&(b=!1);var g=null;switch(this.storage){case"local":if(null===(g=localStorage.getItem(f)))break;var h=new Date;g=d(g),g.expires_time<=h.getTime()&&(this.removeStoredItem(a),g=null);break;case"cookie":for(var i=f+"=",j=c.cookie.split(";"),k=0;k<j.length;k++){var l=j[k];l=l.trim(),0===l.indexOf(i)&&(g=l.substring(i.length,l.length),g=d(g))}}return b&&this.removeStoredItem(a),g},getStoreName:function(a){void 0===a&&(a="");var b=this.settings.baseStorageName+"_";switch(b+=this.settings.clientName,a){case"token":b+="_tk";break;case"state":b+="_st";break;case"return_location":b+="_cloc";break;case"request":b+="_req";break;case"delayed_response":b+="_dlresp";break;case"delayed_error":b+="_dlerr";break;case"feedback_msg":b+="_fbm";break;case"error_msg":b+="_err";break;case"lastAuthReq":b=this.settings.baseStorageName+"_lreq";break;default:b=b+"_"+a}return b},haveToken:function(){return null!==this.getStoredItem("token")},init:function(){function b(a){var b=["token","state","return_location","request","delayed_response","delayed_error","feedback_msg","error_msg"];return void 0===a&&(a=""),a=a.toLowerCase(),b.indexOf(a)>-1}var d=this;a.fn[this._name].responseHandler=function(a){d.responseHandler(a)},a.fn[this._name].makeRequest=function(a){d.makeRequest(a)},a.fn[this._name].saveItem=function(a,c,e){return!b(a)&&(d.storeItem(a,c,e),!0)},a.fn[this._name].retrieveItem=function(a,c){return!b(a)&&d.getStoredItem(a,c)},a.fn[this._name].removeItem=function(a){return!b(a)&&d.removeStoredItem(a)},this.storage="none",0===this.settings.baseStorageName.length&&(this.settings.baseStorageName="eclipseIGC"),"undefined"!=typeof Storage?this.storage="local":navigator.cookieEnabled&&(this.storage="cookie");var e=this.getStoredItem("delayed_response",!0);if(null!=e)return void a(c).trigger("igcRequestComplete",e);var f=this.getStoredItem("delayed_error",!0);if(null!=f)return void a(c).trigger("igcRequestFailed",f);var g=this.getStoredItem("error_msg",!0);if(null!=g)return void a(c).trigger("igcAuthFailed",g);a(c).ready(function(){if(void 0===d.settings.username||0===d.settings.username.length)return void d.removeStoredItem("token");var a=d.getStoredItem("session_user");if(null!==a&&a.username!==d.settings.username)return d.removeStoredItem("token"),void d.storeItem("session_user",{username:d.settings.username},3600);null===a&&d.storeItem("session_user",{username:d.settings.username},3600)})},makeRequest:function(b,d){function e(){f.settings.completeOnAuthorization&&(b.context=null,f.storeItem("request",b)),f.request={clientName:f.settings.clientName,cid:b.cid,scope:b.scope},f.storeItem("lastAuthReq",f.request),f.authorizeClient()}var f=this;if(void 0===d&&(d=!1),this.haveToken()){var g={path:"/",method:"GET",contentType:"application/json",context:a(c),successCallback:null,errorCallback:null},h=a.extend({},g,b);return void a.ajax({url:this.settings.apiUrl+h.path,context:h.context,method:h.method,contentType:h.contentType,beforeSend:function(a){var b=f.getStoredItem("token");a.setRequestHeader("Authorization","Bearer "+b.access_token)}}).done(function(a,b,c){if("function"==typeof h.successCallback)return void h.successCallback(a,b,c);if(d){var e={clientName:f.settings.clientName,data:a,textStatus:b,responseHeaders:c.getAllResponseHeaders(),requestOptions:h};f.storeItem("delayed_response",e),f.redirectToStart()}}).fail(function(a){if(401===a.status)return void e();if("function"==typeof h.errorCallback)return void b.errorCallback(a);if(d){var c={clientName:f.settings.clientName,requestOptions:h,jqXHR:a};f.storeItem("delayed_error",c),f.redirectToStart()}})}e()},openWindow:function(a){var c=b.open(a,"Authorize","height=720, width=1280");b.focus&&c&&c.focus()},redirectToStart:function(){if(!1!==this.settings.redirectIfValid){var a=this.getStoredItem("return_location",!0);null===a&&(a={prevLoc:[location.protocol,"//",location.host].join("")}),b.location.replace(a.prevLoc)}},removeStoredItem:function(a){var b=this.getStoreName(a);switch(this.storage){case"local":localStorage.removeItem(b);break;case"cookie":c.cookie=b+"=;"+"expires=Thu, 01 Jan 1970 00:00:00 UTC;"+"; path=/"}},responseHandler:function(b){function c(a){var b={},c=a.substring(a.indexOf("?"));if(c)for(var d,e=/([^#?&=]+)=([^&]*)/g;null!==(d=e.exec(c));)b[decodeURIComponent(d[1])]=decodeURIComponent(d[2]);return b}var d=this,e=!0;void 0===b&&(b=""),"boolean"!=typeof this.settings.redirectIfValid&&(this.settings.redirectIfValid=!0);var f=c(b);if(!a.isEmptyObject(f)){if(void 0!==f.access_token){if(this.request=this.getStoredItem("lastAuthReq",!0),null==this.request)return void this.redirectToStart();if(this.settings.clientName=this.request.clientName,this.haveToken())return void this.redirectToStart();e=!1,this.validateToken(f,function(a,b){if("boolean"!=typeof a&&(a=!1),!0===a){d.storeItem("token",f);var c=d.getDelayedAction();if(null!=c)return void d.makeRequest(c,!0)}else d.removeStoredItem("request"),void 0!==b&&null!==b&&d.storeItem("error_msg",b);d.redirectToStart()})}void 0!==f.error&&(this.removeStoredItem("request"),this.removeStoredItem("state"),this.storeItem("error_msg",f))}e&&d.redirectToStart()},storeItem:function(a,b,d){var e,f,g=this.getStoreName(a);if(void 0!==b){switch(a){case"token":d=parseInt(b.expires_in)-1,e=new Date,f=1e3*d;break;default:("number"!=typeof d||d<1)&&(d=3600),e=new Date,f=1e3*d,"object"!=typeof b&&(b={itemName:b})}e.setTime(e.getTime()+f),"local"===this.storage&&(b.expires_time=e.getTime());var h=this.settings.encodeStorage?btoa(JSON.stringify(b)):JSON.stringify(b);switch(this.storage){case"local":localStorage.setItem(g,h);break;case"cookie":var i="; expires="+e.toUTCString();c.cookie=g+"="+h+i+"; path=/"}}},validateToken:function(b,c){function d(b,c){var d=e.settings.apiUrl+"/account/profile/"+e.settings.username;a.ajax({url:d}).done(function(a){var d=!0,f=null;void 0!==a.name&&a.uid!==b&&(f={clientName:e.settings.clientName,error:400,error_description:"Authorizing account does not match the current logged in account on this site",error_from:"account/profile"},d=!1),c&&"function"==typeof c&&c(d,f)}).fail(function(a){var b={clientName:e.settings.clientName,error:a.status,error_description:a.statusText,error_from:"account/profile"};c&&"function"==typeof c&&c(!1,b)})}var e=this;if("none"!==this.storage){var f=this.getStoredItem("state",!0);if(null===f||f.state!==b.state)return void(c&&"function"==typeof c&&c(!1))}a.ajax({url:this.settings.authUrl+"/oauth2/tokens/"+b.access_token}).done(function(f){var g=!0,h=null;if(e.request.cid!==f.client_id&&(g=!1,h={clientName:e.settings.clientName,error:400,error_description:"Received token issued to unrecognized Client ID",error_from:"oauth2/tokens"}),g){var i=b.scope.split("+"),j=e.request.scope.split(" "),k=[];a(i).each(function(){-1===j.indexOf(this)&&(g=!1,k.push(this)),g||(h={clientName:e.settings.clientName,error:400,error_description:"Granted scope "+k.join(" ")+"is not in the list of expected scopes",error_from:"oauth2/tokens"})})}if(e.settings.validateUser&&e.settings.username.length>0&&g){var l;void 0!==f.user_id&&(l=f.user_id),d(l,c)}else c&&"function"==typeof c&&c(g,h)}).fail(function(a){var b={clientName:e.settings.clientName,error:a.status,error_description:"Error validating authorization response.",error_from:"validateToken"};c&&"function"==typeof c&&c(!1,b)})}}),a.fn[f]=function(b){return this.each(function(){a.data(this,"plugin_"+f)||a.data(this,"plugin_"+f,new e(this,b))})}}(jQuery,window,document);